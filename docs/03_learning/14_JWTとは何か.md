## JWTとは何か（JSON Web Token）

ログイン後に「この人は認証済みです」という情報を安全にやり取りするためのトークン。

「このリクエストを送ってきたのは、さきほどログインに成功した**あのユーザー本人です**」という事実を、サーバーが覚えておかなくても検証できる。

ポイントは以下の2点:

- トークン自体に**本人確認に必要な情報**が入っている
- サーバーはトークンの正当性を検証するだけでよい

つまりJWTは、

> ログイン済みユーザーであることを
> 毎リクエストごとに自己申告させ、その申告が本物かを検証する仕組み

と言えます。

## なぜJWTが必要？

従来の**セッション方式**:

1. ユーザーがログイン
2. サーバーがセッションIDを発行
3. サーバーは「セッションID → ユーザー情報」をメモリやDBに保存
4. クライアントはCookieにセッションIDを入れて送信
5. サーバーがセッションIDを照合し、ユーザーを特定

問題点:

- サーバーが**状態（セッション情報）を保持**する必要がある
  - ユーザー数が増えれば増えるほど、サーバーのメモリ消費が増える
  - セッション管理のクリーンアップや期限管理をサーバー側で行う必要がある
  - サーバーが落ちると、セッション情報が失われて未ログイン状態になってしまう
- サーバーの台数を増やすと問題が出る
  - 途中で別のサーバーに切り替わった際に、セッション情報が引き継がれない（未ログイン扱いになる）

JWT方式:

1. ユーザーがログイン
2. サーバーがJWTトークンを発行 ※サーバー側で保持しない
    - 誰か / いつ発行されたか / 有効期限 を含む
3. クライアントは JWT を保持（通常は`Authorization: Bearer ...`）
4. リクエストごとに JWT を送信
5. サーバーは**署名が正しいか** / **有効期限が切れていないか**を検証するだけ

利点:

- サーバーがユーザー状態を一切保持しない
- どのサーバーにリクエストが来ても検証できる
- REST API / マイクロサービス / SPA と非常に相性が良い

→ これを**ステートレス（Stateless）**と呼ぶ。

## JWTの構造

JWTは`.`（ドット）で区切られた3つの文字列。

```css
Header.Payload.Signature
```

例:

```nginx
eyJhbGciOiJIUzI1NiJ9
.eyJzdWIiOiJ0ZXN0QGV4YW1wbGUuY29tIiwiaWF0IjoxNzA1ODAwMDAwfQ
.XXXXX
```

| 部分      | 内容         | 意味                                         |
|-----------|--------------|----------------------------------------------|
| Header    | 署名方式など | どのアルゴリズムで署名したか                 |
| Payload   | クレーム情報 | ユーザー識別子・発行時刻・有効期限など       |
| Signature | 電子署名     | 改ざんされていないことの保証                 |

### Header（ヘッダー）

```json
{
  "alg": "HS256",
  "typ": "JWT"
}
```

- `alg`: 署名アルゴリズム
- 「どうやって署名したか」のメタ情報

### Payload（ペイロード）

- PayloadはBase64エンコードされているだけで、暗号化されていない。
- 誰でもデコードして中身を見れる。だからパスワードなどの機密情報は入れない。

```json
{
  "sub": "test@example.com",
  "iat": 1705800000
}
```

- sub（subject）: ユーザー識別子（userId / email など）
- iat（issued at）: 発行時刻

よく使われるもの：

- exp: 有効期限
- iss: 発行者
- roles: 権限

### Signature（署名）

```scss
HMACSHA256(
  base64UrlEncode(header) + "." + base64UrlEncode(payload),
  secretKey
)
```

- サーバーだけが知っている**秘密鍵**を使って署名
- 改ざんされたら検証に失敗する

つまり、

> Payloadは見られてもいい
> でも勝手に書き換えることはできない
