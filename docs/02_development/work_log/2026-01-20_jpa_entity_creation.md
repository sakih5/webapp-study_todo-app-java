# 作業ログ: 2026-01-20 (JPA Entity作成 & ユーザー登録API実装開始)

## 学習情報

- **日付**: 2026-01-20
- **学習フェーズ**: WBS 1.3.1〜1.3.4
- **学習時間**: 約2時間
- **ステータス**: 進行中（ユーザー登録API実装途中）

---

## 実施内容

### 1. ORMの概念学習

ORMとは何か、JPAとHibernateの関係、Spring Data JPAの役割について学習した。

**学んだこと:**
- ORM（Object-Relational Mapping）: SQLを書かずにJavaオブジェクトでDB操作ができる
- JPA: Java標準のORM仕様（インターフェース）
- Hibernate: JPAの実装
- Spring Data JPA: JPAをさらに便利にするSpringの抽象レイヤー

**階層構造:**
```
Spring Data JPA → JPA → Hibernate → JDBC
```

### 2. Userエンティティ作成

**ファイル**: `src/main/java/com/example/todoapp/entity/User.java`

```java
@Entity
@Table(name = "users")
public class User {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "email", nullable = false, length = 255, unique = true)
    private String email;

    @Column(name = "password_hash", nullable = false)
    private String passwordHash;

    @Column(name = "created_at", nullable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;

    // getter/setter省略
}
```

**主要なアノテーション:**
- `@Entity`: このクラスがDBと永続化される対象であることを示す
- `@Table`: テーブル名を明示的に指定
- `@Id`: 主キーを指定
- `@GeneratedValue`: 主キーの生成戦略（IDENTITYはAUTO_INCREMENT）
- `@Column`: カラムの設定（nullable, unique, length等）

### 3. UserRepository作成

**ファイル**: `src/main/java/com/example/todoapp/repository/UserRepository.java`

```java
package com.example.todoapp.repository;

import com.example.todoapp.entity.User;
import org.springframework.data.jpa.repository.JpaRepository;

public interface UserRepository extends JpaRepository<User, Long> {
}
```

**学んだこと:**
- `JpaRepository<エンティティ型, 主キー型>` を継承するだけで基本的なCRUDメソッドが使える
- `interface` として定義する（classではない）
- パッケージ宣言が必須

### 4. テーブル自動作成の確認

アプリケーション起動後、PostgreSQLで確認:

```sql
todoapp=# \d users
                                           Table "public.users"
    Column     |              Type              | Collation | Nullable |             Default
---------------+--------------------------------+-----------+----------+----------------------------------
 id            | bigint                         |           | not null | generated by default as identity
 created_at    | timestamp(6) without time zone |           | not null |
 email         | character varying(255)         |           | not null |
 password_hash | character varying(255)         |           | not null |
 updated_at    | timestamp(6) without time zone |           | not null |
Indexes:
    "users_pkey" PRIMARY KEY, btree (id)
    "uk6dotkott2kjsp8vw4d0m25fb7" UNIQUE CONSTRAINT, btree (email)
```

**確認できたこと:**
- `@Entity` を付けたクラスがテーブルになる
- `@Column` の設定（nullable, unique）がDB制約になる
- `@GeneratedValue(IDENTITY)` が `generated by default as identity` になる
- `spring.jpa.hibernate.ddl-auto=update` でテーブルが自動作成される

---

## 発生した問題と解決策

### 問題1: Dockerコンテナ名の競合

**症状:**
```
Error response from daemon: Conflict. The container name "/todoapp-postgres" is already in use
```

**原因:**
以前、別のディレクトリで同じ名前のコンテナを作成していた。

**解決策:**
```bash
docker rm todoapp-postgres
docker compose up -d
```

### 問題2: パスワード認証エラー

**症状:**
```
FATAL: password authentication failed for user "todoapp"
```

**原因:**
環境変数がGradleプロセスに渡されていなかった。

**解決策:**
```bash
source .env && ./gradlew bootRun
```

または:
```bash
export $(cat .env | xargs) && ./gradlew bootRun
```

### 問題3: Repositoryが認識されない

**症状:**
```
Found 0 JPA repository interfaces.
```

**原因:**
`UserRepository.java` にパッケージ宣言がなかった。

**解決策:**
ファイルの1行目に `package com.example.todoapp.repository;` を追加。

---

## 現在のプロジェクト構造

```
src/main/java/com/example/todoapp/
├── TodoappApplication.java
├── config/
│   └── SecurityConfig.java     ← PasswordEncoder追加
├── controller/
│   └── HelloController.java
├── dto/                        ← 今回作成
│   ├── SignupRequest.java
│   └── UserResponse.java
├── entity/
│   └── User.java
└── repository/
    └── UserRepository.java
```

---

## 追加実施内容（午後）

### 5. Spring Security基礎学習（WBS 1.3.3）

**認証（Authentication）と認可（Authorization）の違い:**

| 用語 | 英語 | 意味 |
|------|------|------|
| 認証 | Authentication | 入口チェック（あなたは誰ですか？） |
| 認可 | Authorization | APIごとの権限チェック（あなたは何をしていいですか？） |

**PasswordEncoderとBCrypt:**

- パスワードは平文で保存してはいけない（DB漏洩時のリスク）
- ハッシュ化: 不可逆な変換、同じ入力は同じ出力（冪等性）
- BCrypt: Spring Bootの事実上の標準、ソルト付き、計算コストが高い

### 6. ユーザー登録API実装開始（WBS 1.3.4）

**完了したファイル:**

1. **SecurityConfig.java** - PasswordEncoderのBean登録を追加

```java
@Bean
public PasswordEncoder passwordEncoder() {
    return new BCryptPasswordEncoder();
}
```

2. **SignupRequest.java** - リクエストDTO

```java
public class SignupRequest {
    @NotBlank
    @Email
    private String email;

    @NotBlank
    private String password;
    // getter/setter
}
```

3. **UserResponse.java** - レスポンスDTO

```java
public class UserResponse {
    private Long id;
    private String email;
    private LocalDateTime createdAt;

    public UserResponse(User user) {
        this.id = user.getId();
        this.email = user.getEmail();
        this.createdAt = user.getCreatedAt();
    }
    // getter/setter
}
```

**未完了（次回のタスク）:**

4. **UserService.java** - ビジネスロジック（これから作成）
   - UserRepositoryに `findByEmail` メソッド追加
   - メール重複チェック
   - パスワードハッシュ化
   - ユーザー保存処理

5. **AuthController.java** - APIエンドポイント（これから作成）

---

## 次回のタスク

1. UserRepositoryに `findByEmail` メソッドを追加
2. UserService.java を作成
3. AuthController.java を作成
4. ユーザー登録APIの動作確認

---

**作成日**: 2026-01-20
**最終更新**: 2026-01-20
