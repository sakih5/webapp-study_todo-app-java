# 作業ログ: 2026-01-26 (Repository層・Service層作成開始)

## 学習情報

- **日付**: 2026-01-26
- **学習フェーズ**: WBS 1.4.1, 1.5.1（エンティティ確認）、1.5.2（Category CRUD API開始）
- **ステータス**: 進行中

---

## 実施内容

### 1. エンティティのテーブル確認

PostgreSQLでテーブル構造を確認した。

#### psqlのページャー問題と解決

**問題**: `\d`コマンドの結果がページャーで表示され、`\q`で終了すると見えなくなる

**解決方法**:
```sql
-- 方法1: ページャーを無効化
\pset pager off

-- 方法2: 1行でコマンド実行
docker compose exec postgres psql -U todoapp -d todoapp -c "\d users"
```

#### テーブル構造の確認結果

**usersテーブル**:
| Column | Type | Nullable | Default |
|--------|------|----------|---------|
| id | bigint | not null | generated by default as identity |
| email | varchar(255) | not null | - |
| password_hash | varchar(255) | not null | - |
| created_at | timestamp(6) | not null | - |
| updated_at | timestamp(6) | not null | - |
| deleted_at | timestamp(6) | | - |

- PRIMARY KEY: id
- UNIQUE: email
- Referenced by: todos, categories

**categoriesテーブル**:
| Column | Type | Nullable | Default |
|--------|------|----------|---------|
| id | uuid | not null | - |
| name | varchar(100) | not null | - |
| color | varchar(20) | not null | - |
| user_id | bigint | not null | - |
| deleted_at | timestamp(6) | | - |

- PRIMARY KEY: id
- UNIQUE: (user_id, name)
- FOREIGN KEY: user_id → users(id)
- Referenced by: todos

**todosテーブル**:
| Column | Type | Nullable | Default |
|--------|------|----------|---------|
| id | uuid | not null | - |
| title | varchar(255) | not null | - |
| description | varchar(255) | | - |
| due | date | | - |
| priority | integer | | - |
| is_completed | boolean | | - |
| user_id | bigint | not null | - |
| category_id | uuid | | - |
| deleted_at | timestamp(6) | | - |

- PRIMARY KEY: id
- FOREIGN KEY: user_id → users(id)
- FOREIGN KEY: category_id → categories(id)

---

### 2. Repository層の作成

#### UserRepository（既存）

```java
public interface UserRepository extends JpaRepository<User, Long> {
    Optional<User> findByEmail(String email);
    boolean existsByEmail(String email);
}
```

#### CategoryRepository（新規作成）

**作成過程での学び**:

1. **importの重要性**: `Category`、`UUID`、`List`などのimportを忘れるとコンパイルエラー
2. **不要なimportの削除**: 使っていないimportは削除すべき
3. **ジェネリクスの型パラメータ**: `List`だけでなく`List<Category>`と指定が必要

**最終コード**:
```java
public interface CategoryRepository extends JpaRepository<Category, UUID> {
    List<Category> findByUser(User user);
}
```

#### TodoRepository（新規作成）

```java
public interface TodoRepository extends JpaRepository<Todo, UUID> {
    List<Todo> findByUser(User user);
}
```

---

### 3. CategoryService作成（途中）

#### Serviceメソッドの戻り値についての学び

**質問**: `create()`メソッドの戻り値は`void`でいい？

**回答**: Controllerの立場で考える
- フロントエンドはカテゴリ作成後、すぐにそのカテゴリにTodoを追加したい場合がある
- `category_id`がないとTodoを作成できない
- 作成したデータを返すと、IDがすぐにわかって便利

**結論**: `Category`を返すのがベター

#### 作成中のメソッド一覧

| メソッド | 説明 | 戻り値 |
|---------|------|--------|
| `create(User user, String name, String color)` | カテゴリ作成 | Category |
| `findByUser(User user)` | ユーザーのカテゴリ一覧取得 | List<Category> |
| `findById(UUID id)` | IDでカテゴリ取得 | Optional<Category> |
| `update(UUID id, String name, String color)` | カテゴリ更新 | Category |
| `delete(UUID id)` | カテゴリ削除（論理削除） | void |

---

## 学んだこと

### 1. psqlのページャー設定

長い出力がページャー（lessなど）で表示される問題は、`\pset pager off`で解決できる。

### 2. Spring Data JPAのメソッド命名規則

`findByXxx(Xxx xxx)`の形式でメソッドを定義すると、Spring Data JPAが自動的にクエリを生成してくれる。

```java
// これだけで WHERE user_id = ? のクエリが自動生成される
List<Category> findByUser(User user);
```

### 3. Javaのジェネリクス

`List`だけでは「何のリストか」が分からないため、`List<Category>`のように型パラメータを指定する必要がある。これを「型安全」という。

```java
// 型安全でない（警告が出る）
List findByUser(User user);

// 型安全
List<Category> findByUser(User user);
```

### 4. Serviceメソッドの戻り値設計

作成系メソッド（`create`）は、作成されたエンティティを返すのが一般的。理由：
- クライアントがすぐにIDを知れる
- 作成後の処理で必要になることが多い

---

## 現在のプロジェクト構造

```
src/main/java/com/example/todoapp/
├── TodoappApplication.java
├── config/
│   └── SecurityConfig.java
├── controller/
│   ├── HelloController.java
│   └── AuthController.java
├── dto/
│   ├── SignupRequest.java
│   ├── UserResponse.java
│   ├── LoginRequest.java
│   └── LoginResponse.java
├── entity/
│   ├── User.java
│   ├── Category.java          ← テーブル確認済み
│   └── Todo.java              ← テーブル確認済み
├── filter/
│   └── JwtAuthenticationFilter.java
├── repository/
│   ├── UserRepository.java
│   ├── CategoryRepository.java  ← 今回作成
│   └── TodoRepository.java      ← 今回作成
├── service/
│   ├── UserService.java
│   └── CategoryService.java     ← 作成中
└── util/
    └── JwtUtil.java
```

---

## 完了したWBSタスク

- [x] 1.4.1 Todoエンティティ作成（テーブル確認済み）
- [x] 1.5.1 Categoryエンティティ作成（テーブル確認済み）
- [x] CategoryRepository作成
- [x] TodoRepository作成

## 進行中のWBSタスク

- [ ] 1.5.2 Category CRUD API（CategoryService作成中）

---

## 次回のタスク

1. CategoryServiceの`create`メソッドを実装
   - UserServiceの`signup`メソッドを参考に
   - new Category() → setXxx() → save() → return
2. CategoryServiceの残りのメソッドを実装
3. CategoryController作成

---

**作成日**: 2026-01-26
**最終更新**: 2026-01-26
